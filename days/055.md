# Kubernetes Sidecar Containers

We have a web server container running the nginx image. The access and error logs generated by the web server are not critical enough to be placed on a persistent volume. However, Nautilus developers need access to the last 24 hours of logs so that they can trace issues and bugs. Therefore, we need to ship the access and error logs for the web server to a log-aggregation service. Following the separation of concerns principle, we implement the Sidecar pattern by deploying a second container that ships the error and access logs from nginx. Nginx does one thing, and it does it well—serving web pages. The second container also specializes in its task—shipping logs. Since containers are running on the same Pod, we can use a shared emptyDir volume to read and write logs.

- Create a pod named `webserver`.

- Create an emptyDir volume `shared-logs`.

- Create two containers from `nginx` and `ubuntu` images with latest tag only and remember to mention tag i.e `nginx:latest`, nginx container name should be `nginx-container` and ubuntu container name should be `sidecar-container` on webserver pod.

- Add command on `sidecar-container`

    ```sh
    "sh","-c","while true; do cat /var/log/nginx/access.log /var/log/nginx/error.log; sleep 30; done"
    ```

- Mount the volume `shared-logs` on both containers at location `/var/log/nginx`, all containers should be up and running.

> Note: The kubectl utility on jump_host has been configured to work with the kubernetes cluster.

## Steps

1. Create a `k3s-pod.yml` using this [YAML file](../files/k3s-sidecar-containers-055.yaml)

2. Create pod

    ```bash
    kubectl apply -f k3s-pod.yml
    ```

3. Verify pod is running

    ```bash
    kubectl get pods

## Good to Know?

### Sidecar Pattern

- **Purpose**: Helper container alongside main application
- **Separation of Concerns**: Each container has specific responsibility
- **Shared Resources**: Share network, storage, and lifecycle
- **Common Use Cases**: Logging, monitoring, proxying, data sync

### Log Aggregation

- **Log Shipping**: Sidecar reads and forwards logs
- **Centralized Logging**: Send logs to central logging system
- **Log Processing**: Parse, filter, and transform logs
- **Multiple Sources**: Collect from different log files

### Sidecar Benefits

- **Modularity**: Separate concerns into different containers
- **Reusability**: Sidecar containers can be reused across applications
- **Independent Updates**: Update sidecar without affecting main app
- **Resource Isolation**: Separate resource limits and requests

### Implementation Patterns

- **Shared Volumes**: Use emptyDir for file sharing
- **Network Sharing**: Containers share localhost network
- **Lifecycle Management**: Containers start/stop together
- **Health Monitoring**: Monitor both main and sidecar containers
